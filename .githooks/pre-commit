#!/bin/sh
set -e

# Find test classes corresponding to staged Java source files
TEST_FILTERS=""
for file in $(git diff --cached --name-only --diff-filter=ACM -- 'src/main/java/**/*.java'); do
    # src/main/java/com/streamforge/core/Foo.java â†’ src/test/java/com/streamforge/core/FooTest.java
    test_file=$(echo "$file" | sed 's|src/main/java/|src/test/java/|;s|\.java$|Test.java|')
    if [ -f "$test_file" ]; then
        class=$(echo "$test_file" | sed 's|src/test/java/||;s|\.java$||;s|/|.|g')
        TEST_FILTERS="$TEST_FILTERS --tests $class"
    fi
done

TASKS="spotlessCheck"
if [ -n "$TEST_FILTERS" ]; then
    TASKS="$TASKS test"
fi

echo "==> Running pre-commit checks..."
# shellcheck disable=SC2086
./gradlew $TASKS $TEST_FILTERS -q

echo "==> All checks passed."
